name: Fix App Config

on:
  push:
    paths:
      - 'k8s/values-rds.template.yaml'
      - '.github/workflows/fix-app.yml'

jobs:
  helm-upgrade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init & Output
        run: |
          cd terraform
          terraform init
          export CATALOG_ENDPOINT=$(terraform output -raw catalog_db_endpoint | cut -d':' -f1)
          export ORDERS_ENDPOINT=$(terraform output -raw orders_db_endpoint | cut -d':' -f1)
          echo "CATALOG_ENDPOINT=$CATALOG_ENDPOINT" >> $GITHUB_ENV
          echo "ORDERS_ENDPOINT=$ORDERS_ENDPOINT" >> $GITHUB_ENV

      - name: Generate Values File
        run: |
          # Use envsubst to replace variables in template
          envsubst < k8s/values-rds.template.yaml > k8s/values-rds.yaml
          cat k8s/values-rds.yaml

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.11.1

      - name: Update Kubeconfig
        run: aws eks update-kubeconfig --name project-bedrock-cluster --region us-east-1

      - name: Login to ECR Public
        run: aws ecr-public get-login-password --region us-east-1 | helm registry login --username AWS --password-stdin public.ecr.aws

      - name: Helm Upgrade
        run: |
          helm upgrade --install my-retail-app oci://public.ecr.aws/aws-containers/retail-store-sample-chart \
            --namespace retail-app \
            --create-namespace \
            --values k8s/values-rds.yaml \
            --wait
