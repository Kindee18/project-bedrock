name: Debug Pods

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/debug-pods.yml'

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update Kubeconfig
        run: aws eks update-kubeconfig --name project-bedrock-cluster --region us-east-1

      - name: Get UI Logs
        run: kubectl logs -n retail-app -l app.kubernetes.io/name=ui --tail=100 || true

      - name: Curl Actuator Env
        run: |
          kubectl run curl-debug --image=curlimages/curl --restart=Never -- sleep 300
          kubectl wait --for=condition=Ready pod/curl-debug -n retail-app --timeout=120s
          kubectl exec -n retail-app curl-debug -- curl -s http://my-retail-app-ui:8080/actuator/env
          kubectl delete pod curl-debug -n retail-app
